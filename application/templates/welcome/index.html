{% extends "../layouts/layout.html" %}
{% block title %}Pixnet Album Maker{% endblock %}
{% block content %}
    <div id="head">
        <h1>Pixnet Album Maker</h1>
    </div>
    <div id="content">
        <div id="tabs">
          <ul>
            <li><a href="#tabs-cond">Select user</a></li>
            <li><a href="#tabs-albums">Select album</a></li>
            <li><a href="#tabs-photos">Select photos</a></li>
            <li><a href="#tabs-output">Output</a></li>
          </ul>
          <div id="tabs-cond">
            <form id="form1" action="/pixnet/albums">
              <fieldset>
                <p>
                  <label>Username:</label>
                  <input type="text" id="username" name="username" value=""/>
                </p>
                <p>
                  <input type="button" id="btn_show" value="Show album sets"/>
                </p>
              </fieldset>
            </form>
          </div>
          <div id="tabs-albums">
            <div id="sets">
            Empty.
            </div>
          </div>
          <div id="tabs-photos">
            <div>
              <input type="button" id="btn_generate" value="Generate"/>
              <input type="button" id="btn_all" value="Select All"/>
              <input type="button" id="btn_none" value="Select none"/>
            </div>
            <div id="photos">
            Empty.
            </div>
          </div>
          <div id="tabs-output">
            <div id="output-html">
              <textarea id="html_textarea" rows="20"></textarea>
            </div>
          </div>
    </div>
    <script id="albumSetTemplate" type="text/x-jquery-tmpl">
        <div class="set">
          <a href="javascript: showPhotos(${id});">
          <img src="${thumb}" alt="${title}"/><br/><span>${title}</span>
          </a>
        </div>
    </script>
    <script id="photoTemplate" type="text/x-jquery-tmpl">
        <div class="photo">
          <a href="${url}" title="${title}" target="_blank">
          <img src="${thumb}" alt="${title}"/></a><br/>
          <input type="checkbox" name="checked" />
          <span><a href="${url}" title="${title}" target="_blank">${title}</a></span>
        </div>
    </script>
    <script type="text/javascript">
        var PAGE1=0;
        var PAGE2=1;
        var PAGE3=2;
        var PAGE4=3;
        // Author: Ariel Flesler
        // http://flesler.blogspot.com/2008/11/fast-trim-function-for-javascript.html
        // Licensed under BSD
        String.prototype.trim = function() {
          var start = -1,
          end = this.length;
          while (this.charCodeAt(--end) < 33);
          while (this.charCodeAt(++start) < 33);
          return this.slice(start, end + 1);
        };
        $(document).ready( function() {
            var $tabs=$("#tabs").tabs();
            $("#btn_show").click( function() {
                var username=$("#username").val().trim();
                if( username=="" ) {
                  alert( "username is empty." );
                  return;
                }
                var jqxhr=$.getJSON("/pixnet/albums", 
                    {
                        'username': username
                    },
                function() {
                })
                .success( function(data) {
                    $( "#sets" ).empty();
                    $( "#albumSetTemplate" ).tmpl( data )
                        .appendTo( "#sets" );
                    $tabs.tabs("select", PAGE2);
                } )
                .error( function() { alert("fail"); } );
            } );
            var winHeight = $(window).height();
            var tabHeight = (winHeight - 10)*10;
            $tabs.height(tabHeight);
            //var contentPanelHeight = $tabs.find(".ui-tabs-panel:visible").height();
            $("#btn_generate").click( function() {
                var style_str="<style type='text/css'>"+
".Album { width: 100%; background: #f5f5f5; padding: 5px;}"+
".AlbumHeader { text-align:center; padding-left:0px; }"+
".AlbumHeader h3 { font: normal 24px Arial, Helvetica, sans-serif; color: #FF0084; text-align: center; }"+
".AlbumHeader h4 { font: 16px Caflisch Script,cursive; color: #660033; text-align: center; }"+
".AlbumPhoto { background: #f5f5f5; margin-bottom: 10px; }"+
".AlbumPhoto p { float: left; padding: 4px 4px 12px 4px; border: 1px solid #ddd; background: #fff; margin: 8px; }"+
".AlbumPhoto span { float: left; padding: 4px 4px 12px 4px; border: 1px solid #ddd; background: #fff; margin: 8px; }"+
".AlbumPhoto img { border: none; } </style>";
                var html_str="<div class='Album'><div class='AlbumHeader'></div><br clear='all'/><div class='AlbumPhoto'>";
                $( "#photos input:checkbox" ).each( function() {
                    if( $(this).attr('checked') ) {
                        var href=$(this).parent().children("a");
                        var img=href.children("img");
                        html_str = html_str + "<span><a href='"+href.attr("href")+"' title='" + img.attr("alt") + "' target='_blank'><img src='"+img.attr("src")+"' alt='"+img.attr("alt")+"'/></a></span>";
                    }
                } );
                html_str=html_str+"</div><br clear='all'/><p align='right'><font sytle='font-size:10px;color:#AABBCC;'>Generated by <a href='http://pixnetalbummaker.appspot.com' target='_blank'>PIXNET Album Maker</a></font></p></div>";
                $("#html_textarea").val( style_str+html_str );
                $tabs.tabs("select", PAGE4);
            } );
            $("#btn_all").click( function() {
                $( "#photos input:checkbox" ).each( function() {
                    var element=$(this);
                    if( !element.attr('checked') )
                        element.attr('checked', true);
                } );
            } );
            $("#btn_none").click( function() {
                $( "#photos input:checkbox" ).each( function() {
                    $(this).attr('checked', false);
                } );
            } );
        } );
        function showPhotos( id ) {
            var $tabs=$("#tabs").tabs();
            var jqxhr=$.getJSON("/pixnet/photos", 
                {
                    'id': id,
                    'username': $("#username").val()
                },
            function() {
            })
            .success( function(data) {
                $( "#photos" ).empty();
                $( "#photoTemplate" ).tmpl( data )
                    .appendTo( "#photos" );
                $tabs.tabs("select", PAGE3);
            } )
            .error( function() { alert("fail"); } );
        }
    </script>
{% endblock %}
